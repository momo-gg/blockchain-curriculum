# 3.6 MEV on Solana

---

## Why This Matters

MEV (Maximal Extractable Value) is one of the most important and controversial topics in blockchain. Understanding it helps you:
- Avoid being exploited when trading
- Understand why some transactions fail or cost more
- Make informed decisions about validator selection
- Grasp a fundamental tension in blockchain design

---

## ğŸŸ¢ General Understanding

### What Is MEV?

MEV is profit extracted by manipulating transaction ordering.

**The Supermarket Analogy**

Imagine you're in a checkout line:

```
You're about to buy the last item on sale.

The cashier (validator) can:
  1. Let you buy it normally
  2. Let their friend cut in line and buy it first
  3. Buy it themselves before you get there

If the item's price goes up after purchase,
whoever bought first makes a profit.
```

**In Blockchain Terms**

```
You submit: "Buy 10 SOL worth of Token X"

Searcher sees your transaction and:
  1. Buys Token X before you (frontrun)
  2. Your purchase moves the price up
  3. Sells Token X after you (backrun)
  4. Profits from the price movement you caused

You got worse price. Searcher extracted value from you.
```

### Why Does Transaction Ordering Create Profit?

**The Price Impact Problem**

```
Token X liquidity pool: 1000 SOL / 1000 TokenX (price = 1 SOL each)

Your trade: Buy 100 TokenX for ~111 SOL (10% of pool, ~11% slippage)

After your trade: 1111 SOL / 900 TokenX (price = 1.23 SOL each)

If someone knew your trade was coming:
  - Buy 50 TokenX at 1.05 SOL (small trade, low impact)
  - Let your trade execute (price goes to 1.23)
  - Sell 50 TokenX at 1.20 SOL
  - Profit: ~7.5 SOL, risk-free
```

### Common MEV Attacks

**1. Frontrunning**

```
Victim Transaction: "Buy Token X"
Attacker Action: Buy Token X BEFORE victim

Result:
  - Attacker gets better price
  - Victim gets worse price
  - Attacker can sell immediately after
```

**2. Sandwich Attack**

```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚            Sandwich Attack              â”‚
   â”‚                                         â”‚
   â”‚  1. Frontrun: Attacker buys             â”‚
   â”‚         â†“                               â”‚
   â”‚  2. Victim's transaction executes       â”‚
   â”‚         â†“                               â”‚
   â”‚  3. Backrun: Attacker sells             â”‚
   â”‚                                         â”‚
   â”‚  Victim is "sandwiched" between         â”‚
   â”‚  attacker's buy and sell                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. Liquidation Racing**

```
Protocol: If collateral < 150% of loan, anyone can liquidate

Attacker monitors for undercollateralized positions
  â†’ Liquidates them first (earns liquidation bonus)
  â†’ Legitimate liquidators lose opportunity
```

**4. Arbitrage (Not Always Bad)**

```
DEX A: Token X = 1.00 SOL
DEX B: Token X = 1.05 SOL

Arbitrageur:
  - Buy on DEX A (cheap)
  - Sell on DEX B (expensive)
  - Profit: 0.05 SOL per token

This actually helps:
  - Equalizes prices across markets
  - Improves market efficiency
```

### Is MEV Good or Bad?

**Arguments It's Bad:**
- Users get worse prices (value extraction)
- Creates unfair advantages (information asymmetry)
- Leads to "gas wars" (higher fees for priority)
- Centralizes power (big players dominate)

**Arguments It's Neutral/Good:**
- Arbitrage improves price efficiency
- Creates incentive to find bugs (white-hat MEV)
- Funds validator operations (if shared)
- Will exist regardless (might as well organize it)

> ğŸ’¡ **Key Insight**: MEV is like a tax on uninformed trading. It exists because of how markets work, not because of blockchain design. Blockchains just make it more visible.

> âœ… **Check Your Understanding**
> - [ ] What is MEV in simple terms?
> - [ ] How does a sandwich attack work?
> - [ ] Why is arbitrage sometimes considered good?
> - [ ] Who benefits from MEV?

---

## ğŸŸ¡ PM/EM Depth

### MEV on Solana vs. Ethereum

**Key Differences**

| Aspect | Ethereum | Solana |
|--------|----------|--------|
| Block/slot time | Longer | Shorter (Solana slot target ~400ms) |
| Mempool | Public, searchable | No public, gossip-based mempool |
| MEV auction | Flashbots MEV-boost | Jito |
| Searcher speed requirement | Lower latency needed | Much lower latency needed |
| MEV distribution | Validators | Validators (policy varies) |

Solana slot timing is based on protocol constants (as of [`solana-labs/solana` clock constants](https://github.com/solana-labs/solana/blob/master/sdk/program/src/clock.rs)).

**Why Solana MEV Is Different**

```
Ethereum:
  - Transactions wait in a public mempool
  - Anyone can see pending transactions

Solana:
  - Transactions are forwarded to the scheduled leader
  - No public mempool to monitor (private queues still exist)
  - Shorter slot windows

Result:
  - Harder to extract MEV on Solana
  - But still possible (watching for patterns)
  - Requires lower latency infrastructure
```

> âš ï¸ **Trading Risk Vocabulary (Quick Map)**
> - **Slippage** and **price impact**: your trade can move the price.
> - **Liquidity** and **bid-ask spread**: thin markets mean worse fills.
> - **Leverage** and **liquidation**: borrowed exposure can force losses.
> - **Perps** and **funding rate**: ongoing costs can erode positions.
> - **Stop loss**: a safety tool, not a guarantee of exit price.

### What Is Jito?

Jito provides MEV infrastructure for Solana (as of [jito.wtf](https://www.jito.wtf/)):

**Jito Components**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Jito Ecosystem                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   SEARCHERS                    VALIDATORS                    â”‚
â”‚   (Extract MEV)                (Run Jito client)            â”‚
â”‚        â”‚                              â”‚                      â”‚
â”‚        â–¼                              â–¼                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ Bundles  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ Jito-Solana  â”‚              â”‚
â”‚   â”‚ (Tx sets)â”‚                â”‚   Client     â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚        â”‚                              â”‚                      â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â–¼                                       â”‚
â”‚              JITO BLOCK ENGINE                               â”‚
â”‚              (Auction for ordering)                          â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â–¼                                       â”‚
â”‚              TIPS DISTRIBUTED                                â”‚
â”‚              (Validators; some share with stakers)           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**How Jito Bundles Work**

```
Bundle = Atomic set of transactions

Example Bundle (Sandwich):
  tx1: Buy Token X      â† Searcher's frontrun
  tx2: Victim's swap    â† Original user transaction
  tx3: Sell Token X     â† Searcher's backrun
  tip: 0.01 SOL         â† Payment to validator

All three execute together or none do.
Searcher guarantees their order.
```

**Jito Adoption**

Adoption varies by validator; tips and sharing policies are set by operators and stake pools.

### Example: Sandwich in One Picture

```
Pool price before: 100

1) Searcher buys first (price up)
2) User swaps at worse price
3) Searcher sells (price normalizes)

Result:
- User pays more than expected
- Searcher captures the spread
```

### How Can I Protect Myself from MEV?

**For Regular Users**

| Protection | How It Works | Trade-off |
|------------|--------------|-----------|
| Use Limit Orders | Price guaranteed, no slippage | Might not fill |
| Lower Slippage | Smaller sandwich profit | Might fail in volatile markets |
| Use Private RPCs | Txs not broadcast publicly | Centralization, trust |
| Use MEV Protection | Jupiter, Raydium protection | Slight delay, fees |
| Smaller Trades | Less profitable to attack | Inconvenient |

**MEV Protection (General)**

Some applications and RPC providers offer private routing or bundle protections; details vary by provider and should be verified per product.

**RPC Selection**

```
Public RPCs:
  - Free but broadcast to many parties
  - Higher MEV exposure

Private/Premium RPCs:
  - Direct connection to leader
  - Lower MEV exposure
  - Cost money

Staked Connection:
  - Priority based on stake
  - Better transaction inclusion
  - Requires SOL staked
```

### MEV Economics

MEV distribution depends on the transaction path, tip policies, and validator commissions.

**Is This Fair?**

Perspectives:
- **Pragmatist**: MEV will happen anyway, at least Jito distributes it
- **Idealist**: Should focus on eliminating MEV, not institutionalizing it
- **User**: Still losing money, just to different parties

> âœ… **Check Your Understanding**
> - [ ] How is MEV different on Solana vs Ethereum?
> - [ ] What does Jito do?
> - [ ] What factors influence Jito adoption?
> - [ ] How can users protect themselves from MEV?

---

## ğŸ”µ Engineer Depth

### Bundle Structure

```rust
pub struct Bundle {
    /// Transactions to execute atomically
    pub transactions: Vec<VersionedTransaction>,
    /// Tip to validator (in lamports)
    pub tip_lamports: u64,
}

// Bundle constraints:
// - Max 5 transactions
// - All must succeed or all fail
// - Tip must be in last transaction
// - Tip goes to validator's tip account
```

### Searcher Infrastructure

```
Searcher System Architecture:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Searcher Bot                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   DATA INGESTION              OPPORTUNITY DETECTION          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ Geyser      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Price Arbitrage  â”‚          â”‚
â”‚   â”‚ (Account    â”‚             â”‚ Detector         â”‚          â”‚
â”‚   â”‚  changes)   â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ Sandwich         â”‚          â”‚
â”‚   â”‚ Transaction â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Detector         â”‚          â”‚
â”‚   â”‚ Stream      â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                               â”‚ Liquidation      â”‚          â”‚
â”‚                               â”‚ Detector         â”‚          â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                       â”‚                      â”‚
â”‚                                       â–¼                      â”‚
â”‚                              EXECUTION ENGINE                â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                              â”‚ Bundle Builder   â”‚           â”‚
â”‚                              â”‚ Simulation       â”‚           â”‚
â”‚                              â”‚ Tip Calculator   â”‚           â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                       â”‚                      â”‚
â”‚                                       â–¼                      â”‚
â”‚                              SUBMISSION                      â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                              â”‚ Jito Block Engineâ”‚           â”‚
â”‚                              â”‚ Direct to Leader â”‚           â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Geyser Plugins

Searchers use Geyser plugins for real-time data:

```rust
// Geyser plugin interface
pub trait GeyserPlugin {
    fn update_account(
        &self,
        account: ReplicaAccountInfoVersions,
        slot: u64,
        is_startup: bool,
    ) -> Result<()>;

    fn notify_transaction(
        &self,
        transaction: ReplicaTransactionInfoVersions,
        slot: u64,
    ) -> Result<()>;
}

// Searcher watches for:
// - Price changes in AMM pools (arbitrage opportunities)
// - Large pending swaps (sandwich opportunities)
// - Undercollateralized positions (liquidations)
```

### Jito Block Engine API

```rust
// Submitting a bundle to Jito
async fn submit_bundle(
    client: &JitoBlockEngineClient,
    bundle: Bundle,
) -> Result<BundleId> {
    // Bundle is simulated first
    let simulation = client.simulate_bundle(&bundle).await?;

    if !simulation.success {
        return Err(SimulationFailed(simulation.error));
    }

    // Calculate appropriate tip
    let tip = calculate_optimal_tip(
        simulation.profit,
        current_competition,
    );

    // Submit to block engine
    let bundle_id = client.send_bundle(bundle, tip).await?;

    // Wait for confirmation
    let status = client.get_bundle_status(bundle_id).await?;

    Ok(bundle_id)
}
```

### Anti-MEV Techniques

**1. Private Transaction Submission**

```rust
// Instead of public RPC:
let public_rpc = RpcClient::new("https://api.mainnet-beta.solana.com");

// Use private endpoint:
let private_rpc = RpcClient::new_with_commitment(
    "https://private-rpc.example.com",
    CommitmentConfig::confirmed(),
);

// Transaction goes directly to validator
// No public mempool exposure
```

**2. Commit-Reveal Schemes**

```rust
// Phase 1: Commit
let secret = random_bytes(32);
let commitment = hash([intent, secret]);
commit_transaction(commitment); // Reveals nothing about intent

// Phase 2: Reveal (after commitment is confirmed)
reveal_transaction(intent, secret);
// Validator verifies hash matches
// By now, it's too late to frontrun
```

**3. Threshold Encryption**

```rust
// Transaction encrypted with threshold key
// Only enough validators together can decrypt
// Decryption happens after ordering committed

struct EncryptedTransaction {
    ciphertext: Vec<u8>,
    // Decrypted only after slot assignment
}

// Searchers can't see content until it's too late
```

**4. Batch Auctions**

```rust
// Instead of continuous execution:
// 1. Collect orders for time period
// 2. Match at uniform clearing price
// 3. Execute all at once

// No ordering advantage
// Everyone gets same price
```

### Measuring MEV

**On-Chain Analysis**

```rust
// Detect sandwich attacks
fn detect_sandwich(transactions: &[Transaction]) -> Vec<SandwichAttack> {
    let mut sandwiches = vec![];

    for window in transactions.windows(3) {
        let [tx1, tx2, tx3] = window else { continue };

        // Check pattern:
        // tx1: Buy token A (attacker)
        // tx2: Buy token A (victim, larger)
        // tx3: Sell token A (attacker)

        if is_same_pair(&tx1, &tx3)
            && is_opposite_direction(&tx1, &tx3)
            && is_same_direction(&tx1, &tx2)
            && tx2.amount > tx1.amount
        {
            sandwiches.push(SandwichAttack {
                frontrun: tx1.clone(),
                victim: tx2.clone(),
                backrun: tx3.clone(),
                profit: calculate_profit(tx1, tx3),
            });
        }
    }

    sandwiches
}
```

**MEV Dashboard Metrics**

```yaml
tracked_metrics:
  daily_mev_volume: "Total SOL extracted"
  sandwich_count: "Number of sandwich attacks"
  arb_count: "Number of arbitrage trades"
  tip_volume: "Total tips to validators"
  top_searchers: "Most active MEV extractors"
  victim_losses: "User value lost to MEV"
```

### Future MEV Mitigation

**Potential Solutions Being Researched**

| Approach | Description | Status |
|----------|-------------|--------|
| Multiple concurrent leaders | Reduces single leader ordering power | Research |
| Encrypted mempools | Hide transactions until committed | Research |
| MEV smoothing | Distribute MEV across all validators | Proposed |
| Order flow auctions | Users sell ordering rights | Experimental |
| Application-level protection | DApps implement protections | Active |

> âœ… **Check Your Understanding**
> - [ ] How do searchers detect MEV opportunities?
> - [ ] What's a Geyser plugin and why do searchers use them?
> - [ ] Describe two anti-MEV techniques
> - [ ] How would you detect a sandwich attack on-chain?

---

## Key Takeaways

1. **MEV = value from transaction ordering** â€” affects everyone who trades
2. **Sandwich attacks** sandwich your trade between buy and sell
3. **Arbitrage** can be beneficial (price efficiency) or harmful (extraction)
4. **Jito is a major MEV route** â€” adoption varies by validator
5. **Protection options exist** â€” limit orders, private RPCs, app-level protection
6. **MEV is distributed** via tips â€” validators receive tips, policies vary
7. **No perfect solution** â€” MEV is fundamental to open markets

---

## Next

Let's compare Solana to other blockchains and understand its competitive position.

â†’ [3.7 Solana vs. The Competition](./3.7-solana-vs-competition.md)
